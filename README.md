## assembly

### 機械語と高水準言語(高級言語)
#### 機械語(マシン語)
ソースコードをコンパイルしてできるファイルにはCPUに対する命令とデータが羅列されている。1番はデータを書く、2番はデータを読む、というように命令ごとに番号がついている。

※ 2進数で10001000、16進数で0x88 など。これは特定のCPUでMOVを表す例である。

#### アセンブリ言語 (低水準言語)
命令がただの番号では人間にとって分かりにくいので、MOVやADDなどで書けるようにした。

人間にとって分かりやすい名前(ニーモニック)をつけだだけであるため、ソースコードが機械語に一対一で対応している。

アセンブラ(コンパイラ)で機械語にアセンブル(コンパイル)することで動作する。  

#### C言語 (高水準言語)
人間が読み書きしやすいように生まれたプログラム言語。

`print ("Hello, world")` のような見慣れたもの。

コンパイラがソースコードを機械が理解できるように変換してくれる。  
人間が読み書きしやすいようにしているだけなので、機械語を理解して直接書くこともできる。  

Ｃ言語はＵＮＩＸを書くために開発された言語で、初期のＣコンパイラはアセンブラであった。いまのC言語のコンパイラはC言語で書かれている。  

### NASMでアセンブリ
#### セクション
##### テキスト
処理を記述する。  
global _start はプログラムのエントリーポイント。  
ld (リンカ)で _start の処理から開始するように実行ファイルを作成する。

##### データ
データを格納するために使用する。

#### レジスタ
レジスタは記憶領域。CPUにデータを保存することが可能で、メモリよりも高速に動作する。  
高速ではあるが数個から数十個（数十バイト程度）と容量が限られる。

- rax : システムコール番号
- rdi : 第1引数
- rsi : 第2引数
- rdx : 第3引数
- r10 : 第4引数
- r9  : 第5引数
- r8  : 第6引数

必要な引数の情報などは man コマンドなどで知ることができる。  
例: `man 2 write`

#### システムコールを実行する手順
- システムコール番号の指定
- システムコールに引数を渡す設定
- システムコールの実行

``` nasm
; システムコール番号の指定
mov rax, 1   ; sys_write

; システムコールに渡す引数をレジスタに格納
mov rdi, 1      ; ファイルディスクリプタ 標準出力(STDOUT)
mov rsi, msg    ; バイト列の先頭アドレス('H'のアドレス)
mov rdx, length ; 書き込むバイト数

; システムコール実行
syscall

```
##### システムコール番号の指定
- raxレジスタにシステムコール番号を設定

##### システムコール番号
- [Linux System Call Table](http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/)
- [github.com/torvalds/linux](https://github.com/torvalds/linux/blob/cd6c84d8f0cdc911df435bb075ba22ce3c605b07/arch/x86/entry/syscalls/syscall_64.tbl#L9-L357) 

##### システムコールに引数を渡す設定
- rdiレジスタにファイルディスクリプタを設定
- rsiレジスタにバイト列の先頭アドレスを設定
- rdxレジスタに書き込むバイト数を設定

※ 渡すことができる引数は6つで rdi、rsi、rdx、r10、r9、r8

##### システムコールの実行
- syscall命令を実行

※ 64bit版であり32bit版では異なる。

